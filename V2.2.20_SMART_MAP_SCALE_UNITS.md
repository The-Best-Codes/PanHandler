# v2.2.20 - Smart Map Scale Unit Switching

## Release Date
October 17, 2025

## Summary
Intelligent unit conversion when switching between metric (cm) and imperial (in) screen units in Map Scale mode.

---

## ğŸ¯ Feature: Smart Unit Switching

### User Request
> "In map scale mode if I'm in feet and I switch to metric it should switch to meters. If I'm in inches and I switch to metric it should switch to centimeters. If I'm in miles and I switch to metric it should automatically switch to kilometers and vice versa so that the proper units are matching up."

### What Changed
When you switch the **screen unit** (cm â†” in), the **real-world unit** now automatically switches to the appropriate matching unit.

---

## Unit Conversion Logic

### Switching to Metric (cm)
**User Action:** Tap "cm" button

| Current Real Unit | New Real Unit | Reason |
|-------------------|---------------|---------|
| `ft` (feet) | â†’ `m` (meters) | Small-scale metric equivalent |
| `mi` (miles) | â†’ `km` (kilometers) | Large-scale metric equivalent |
| `m` (meters) | â†’ `m` (no change) | Already metric |
| `km` (kilometers) | â†’ `km` (no change) | Already metric |

### Switching to Imperial (in)
**User Action:** Tap "in" button

| Current Real Unit | New Real Unit | Reason |
|-------------------|---------------|---------|
| `m` (meters) | â†’ `ft` (feet) | Small-scale imperial equivalent |
| `km` (kilometers) | â†’ `mi` (miles) | Large-scale imperial equivalent |
| `ft` (feet) | â†’ `ft` (no change) | Already imperial |
| `mi` (miles) | â†’ `mi` (no change) | Already imperial |

---

## Examples

### Example 1: Blueprint (Feet to Meters)
1. **Initial:** `1 in = 10 ft` (blueprint scale)
2. **User taps "cm"**
3. **Result:** `1 cm = 10 m` (automatically switched ft â†’ m)

### Example 2: Hiking Map (Kilometers to Miles)
1. **Initial:** `1 cm = 1 km` (hiking map)
2. **User taps "in"**
3. **Result:** `1 in = 1 mi` (automatically switched km â†’ mi)

### Example 3: City Map (Miles to Kilometers)
1. **Initial:** `1 in = 0.25 mi` (city map)
2. **User taps "cm"**
3. **Result:** `1 cm = 0.25 km` (automatically switched mi â†’ km)

### Example 4: Blueprint (Meters to Feet)
1. **Initial:** `1 cm = 5 m` (metric blueprint)
2. **User taps "in"**
3. **Result:** `1 in = 5 ft` (automatically switched m â†’ ft)

---

## User Experience

### Before Fix
âŒ User switches cm â†’ in, but real unit stays as "km" (mismatch!)
âŒ Have to manually tap the correct real unit
âŒ Easy to create incorrect scale (e.g., "1 in = 1 km" doesn't make sense)
âŒ Confusing workflow

### After Fix
âœ… Switch cm â†’ in, real unit auto-adjusts to mi/ft
âœ… Switch in â†’ cm, real unit auto-adjusts to km/m
âœ… Units always make logical sense together
âœ… Faster, more intuitive workflow
âœ… Prevents user errors

---

## Technical Details

### File Modified
`/src/components/VerbalScaleModal.tsx` - Lines 296-337 (screen unit toggle buttons)

### Implementation
Added conditional logic to the screen unit buttons:

```typescript
// CM button
onPress={() => {
  setScreenUnit('cm');
  // Smart unit switching: cm â†’ metric units
  if (realUnit === 'ft') setRealUnit('m');
  if (realUnit === 'mi') setRealUnit('km');
  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
}}

// IN button
onPress={() => {
  setScreenUnit('in');
  // Smart unit switching: in â†’ imperial units
  if (realUnit === 'm') setRealUnit('ft');
  if (realUnit === 'km') setRealUnit('mi');
  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
}}
```

### Why This Works
- **Feet â†” Meters:** Both are small/medium scale (buildings, rooms, blueprints)
- **Miles â†” Kilometers:** Both are large scale (maps, hiking trails, cities)
- **Preserves Scale Intent:** User's intended scale remains consistent, just converted to appropriate unit system

---

## Edge Cases

### Already Matching Units
If the real unit is already in the correct system, it doesn't change:
- `cm` + `m` â†’ stays `m` (already metric)
- `in` + `ft` â†’ stays `ft` (already imperial)

### User Can Still Override
After auto-switching, user can still manually select any real unit they want. This is just a smart default.

---

## Testing Checklist

### Metric â†’ Imperial
- [x] `1 cm = 10 m` â†’ Tap "in" â†’ `1 in = 10 ft` âœ“
- [x] `1 cm = 1 km` â†’ Tap "in" â†’ `1 in = 1 mi` âœ“
- [x] `2 cm = 5 m` â†’ Tap "in" â†’ `2 in = 5 ft` âœ“

### Imperial â†’ Metric
- [x] `1 in = 10 ft` â†’ Tap "cm" â†’ `1 cm = 10 m` âœ“
- [x] `1 in = 0.25 mi` â†’ Tap "cm" â†’ `1 cm = 0.25 km` âœ“
- [x] `0.5 in = 20 ft` â†’ Tap "cm" â†’ `0.5 cm = 20 m` âœ“

### Edge Cases
- [x] `1 cm = 1 m` â†’ Tap "in" â†’ `1 in = 1 ft` (m â†’ ft) âœ“
- [x] `1 in = 1 ft` â†’ Tap "cm" â†’ `1 cm = 1 m` (ft â†’ m) âœ“
- [x] Already matching units don't change unexpectedly âœ“

---

## Why This Matters

### Real-World Use Cases

**Blueprint Architect (US):**
- Works in imperial: `1 in = 10 ft`
- Collaborator uses metric: Switch to `1 cm = 10 m`
- Units automatically match! ğŸ¯

**Hiking Map (Europe):**
- Map shows: `1 cm = 1 km`
- American hiker: Switch to `1 in = 1 mi`
- Instantly understandable! ğŸ¥¾

**Construction Plans:**
- Metric blueprint: `1 cm = 5 m`
- US contractor: Switch to `1 in = 5 ft`
- No conversion errors! ğŸ—ï¸

---

## Version History
- **v2.2.17** - Map scale UX improvement
- **v2.2.18** - Undo single point + feet/inches formatting
- **v2.2.19** - Fixed polygon auto-detection
- **v2.2.20** - Smart map scale unit switching (current)

## Files Changed
1. `/src/components/VerbalScaleModal.tsx` - Smart unit conversion logic
